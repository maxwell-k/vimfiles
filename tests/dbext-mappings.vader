" Initialise{{{1
After:
  DBResultsClose

Execute (Function to hide irrelevant details):
  source ./dbext-mask.vim " defines DBextPostResult

" Turn off header and jobs{{{1
Execute (Turn off header and jobs):
  Save g:dbext_default_SQLITE_cmd_header
  let g:dbext_default_SQLITE_cmd_header = ''
  DBSetOption SQLITE_cmd_header=''
  DBSetOption job_enable=0

Then (Check header and jobs are off):
  AssertEqual '', DB_listOption('SQLITE_cmd_header')
  AssertEqual '',g:dbext_default_SQLITE_cmd_header
  AssertEqual '0', DB_listOption('job_enable')

" Test a basic select works{{{1
Execute (Test "SELECT 1"):
  DBExecSQL SELECT 1 ;
  buffer Result

Expect (1 with no header):
  Connection: T(SQLITE)  D(XXXXX)   at XX:XX
  1

" Test a default mapping - <Leader>sel{{{1
Given sql (Select 2):
  SELECT 2;

Do (Run with \sel):
  \sel\<c-w>j

Expect (2 with no header):
  Connection: T(SQLITE)  D(XXXXX)   at XX:XX
  2

" Test a default mapping in reStructuredText - <Leader>sel{{1
Given rst (Select 2.1):
  Example sql::
    SELECT 2.1;

Do (Run with \sel):
  G
  \sel\<c-w>j

Expect (2 with no header):
  Connection: T(SQLITE)  D(XXXXX)   at XX:XX
  2.1

" Test an opfunc mapping - <Leader>l{{{1
Given sql (Select 2, 1):
  SELECT 2,1;

Do (Run with \ll opfunc):
  \ll\<c-w>j

Expect (2|1 with no header):
  Connection: T(SQLITE)  D(XXXXX)   at XX:XX
  2|1

" Move back to default settings with jobs enabled{{{1
Execute (Default settings, no header):
  Restore g:dbext_default_SQLITE_cmd_header
  execute 'DBSetOption SQLITE_cmd_header='.g:dbext_default_SQLITE_cmd_header
  DBSetOption job_enable=1

Then (Check jobs enabled):
   AssertEqual 1, g:dbext_default_use_jobs

" Test a default mapping - <Leader>sel{{{1
Given sql (Select 3):
  SELECT 3;

Do (Run with \sel):
  \sel\<c-o>:sleep 1\<Enter>\<c-w>j

Expect (3 with a header):
  Connection: T(SQLITE)  D(XXXXX)   at XX:XX
  job started:XX:XX:XX updates every 2000 ms
  3
  ----------
  3

" Test an opfunc mapping - <Leader>L{{{1
Given sql (Select 4, 0):
  SELECT 4, 0;

Do (Run with \LL opfunc):
  \LL\<c-o>:sleep 1\<Enter>\<c-w>j

Expect (4|0 with no header):
  Connection: T(SQLITE)  D(XXXXX)   at XX:XX
  job started:XX:XX:XX updates every 2000 ms
  4|0

" Tear down{{{1
Execute (Clear function):
    delfunction DBextPostResult
" vim: set foldlevel=0 :
