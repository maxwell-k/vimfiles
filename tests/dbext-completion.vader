"Setup connection and create database tables{{{1
Execute (Setup DB and create tables):
  set filetype=sql

  Save g:dbext_default_job_enable
  " if the tests in this file are run before any connection is made
  let g:dbext_default_dbname = 'vader.sqlite'
  let g:dbext_default_job_enable = 0
  " if the tests in this file are run after a connection is made , e.g. in a
  " suite
  execute 'DBSetOption dbname=' g:dbext_default_dbname
  execute 'DBSetOption job_enable=' g:dbext_default_job_enable

  " create some test data
  DBExecSQL CREATE TABLE IF NOT EXISTS table_one(one, two, three);
  DBExecSQL CREATE TABLE IF NOT EXISTS table_two(four, five, six);
  DBExecSQL CREATE TABLE IF NOT EXISTS table_three("a b", "c d", e);
  DBResultsClose

Then (Check synchronous):
  AssertEqual 0, g:dbext_default_job_enable

"Table name completion{{{1
Given sql (Incomplete table names):
  SELECT * FROM table_o
  SELECT * FROM table_tw

Do (Complete):
  1ggA\<c-x>\<c-o>\<Esc>
  2ggA\<c-x>\<c-o>\<Esc>

Expect (Table names completed):
  SELECT * FROM table_one
  SELECT * FROM table_two

Given sql (Incomplete table names):
  SELECT * FROM table_o
  SELECT * FROM table_tw

Do (Complete again):
  1ggA\<s-Tab>t\<Esc>
  2ggA\<s-Tab>t\<Esc>

Expect (Table names completed again):
  SELECT * FROM table_one
  SELECT * FROM table_two

"Column drill down{{{1
Given sql (Incomplete column names):
  SELECT

"You must complete using a table first before you can complete a column on its
"own
Do (Complete three column names):
  otable_one.\<s-Tab>c\<Esc>
  o,\<s-Tab>c\<c-n>\<Esc>
  o,\<s-Tab>c\<c-n>\<c-n>\<Esc>

Expect (Column names completed):
  SELECT
  table_one.one
  ,two
  ,three

" Drill down{{{1
Given sql (Complete tables with drill down):
  FROM

Do (Tab, shift tab and ctrl n):
  Go\<s-Tab>t\<Esc>
  Go,\<s-Tab>t\<C-N>\<C-N>\<Esc>
  Go,\<s-Tab>t\<C-N>\<Esc>

Expect (Tables in order):
  FROM
  table_one
  ,table_two
  ,table_three

Given sql (Complete columns with drill down):
  SELECT

" see :help sql-completion-dynamic
" this test works around various limitations of vader
" - use Execute instead of Do so that tabs work
" - can only be select the first column, for some reason <C-N> doesn't work
"   after a tab, an alternative test can't be found
" use :execute to represent special characters with printable characters
Execute (Shift-tab, ctrl-n and tab):
  exe "normal Go\<s-Tab>t\t"
  exe "normal Go,\<s-Tab>t\<C-N>\<C-N>\t"
  exe "normal Go,\<s-Tab>t\<C-N>\t"

Expect (First column from each table):
  SELECT
  one
  ,four
  ,"a b"

" The built in completion uses ``s:save_prev_table`` which is only set when
" doing column completion: autoload/sqlcomplete.vim:421 in vim 8.0

" Tear down{{{1
Given:

"   DBSetOption sees the second : in :memory: as an option separator, even when
"   escaped, so don't even try to reset the dbname
Execute (Clear db file):
  silent !rm -f vader.sqlite

Include: includes/reset-jobs.vader

" vim: set foldlevel=0 :
